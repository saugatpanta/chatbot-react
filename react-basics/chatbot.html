<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Chatbot</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 0;
      }

      .app-container {
        max-width: 600px;
        margin: auto;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .chat-msg-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        scrollbar-width: none;
      }

      .chat-msg-user, .chat-msg-robot {
        display: flex;
        margin-top: 20px;
      }

      .chat-msg-user {
        justify-content: flex-end;
      }

      .chat-msg-robot {
        justify-content: flex-start;
      }

      .chat-msg-text {
        background: #eee;
        border-radius: 10px;
        padding: 12px 18px;
        font-size: 15px;
        max-width: 300px;
      }

      .chat-msg-profile {
        width: 45px;
        height: 45px;
      }

      .chat-input-container {
        display: flex;
        border-top: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 60px;
      }

      .user-input {
        flex: 1;
        padding: 12px 15px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 15px;
      }

      .send-button {
        background: rgb(25, 135, 84);
        color: #fff;
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        margin-left: 10px;
        cursor: pointer;
        font-size: 15px;
      }

      .loading-dots {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: 20px;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #198754; /* matches Send button */
      animation: pulse 1s ease-in-out infinite;
    }

    .loading-dots span:nth-child(1) {
      animation-delay: 0s;
    }
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes pulse {
      0%, 80%, 100% {
        opacity: 0.4;
        transform: scale(0.8);
      }
      40% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    @media (prefers-color-scheme: dark) {
      .loading-dots span {
        background-color: #22c55e;
      }
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255, 255, 255, 0.4);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }


    </style>
  </head>

  <body>
    <div class="js-container"></div>

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>
    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script type="text/babel">
      function ChatInput({ onSend, isLoading }) {
        const [text, setText] = React.useState('');

        function handleSend() {
          if (!text.trim() || isLoading) return;
          onSend(text);
          setText('');
        }

        return (
          <div className="chat-input-container">
            <input
              type="text"
              placeholder="Send a message to Chatbot"
              value={text}
              onChange={(e) => setText(e.target.value)}
              disabled={isLoading}
              className="user-input"
            />
            <button
              onClick={handleSend}
              disabled={isLoading}
              className="send-button"
            >
              {isLoading ? <div className="spinner"></div> : 'Send'}
            </button>
          </div>
        );
      }

      function ChatMessage({ message, sender }) {
        return (
          <div
            className={
              sender === 'user' ? 'chat-msg-user' : 'chat-msg-robot'
            }
          >
            {sender === 'robot' && (
              <img src="/assets/robot.png" alt="" className="chat-msg-profile" />
            )}
            <div 
              className="chat-msg-text"
              dangerouslySetInnerHTML={{ __html: message }}
            >
            </div>
            {sender === 'user' && (
              <img src="/assets/user.png" alt="" className="chat-msg-profile" />
            )}
          </div>
        );
      }

      function ChatMessages() {
        const chatMsgesRef =  React.useRef(null);
        
        const [chatMessages, setChatMessages] = React.useState([
          { message: 'hello Chatbot', sender: 'user', id: 'id1' },
          { message: 'Hello! How can I help you?', sender: 'robot', id: 'id2' },
        ]);
        const [isLoading, setIsLoading] = React.useState(false);

        React.useEffect(()=>{
          const containerElem = chatMsgesRef.current;
          if(containerElem){
            containerElem.scrollTop = containerElem.scrollHeight;
          }
        },[chatMessages])//dependency array

        async function sendMessage(messageText) {
          setChatMessages((prev) => [
            ...prev,
            { message: messageText, sender: 'user', id: crypto.randomUUID() },
          ]);

          setIsLoading(true);

          setChatMessages((prev) => [
            ...prev,
            { message: 
                '<div class="loading-dots"><span></span><span></span><span></span></div>', 
              sender: 'robot', 
              id: 'loading' 
            },
          ]);

          try {
            const response = await Chatbot.getResponseAsync(messageText);
            setChatMessages((prev) =>
              prev
                .filter((msg) => msg.id !== 'loading')
                .concat({
                  message: response,
                  sender: 'robot',
                  id: crypto.randomUUID(),
                })
            );
          } catch {
            setChatMessages((prev) =>
              prev
                .filter((msg) => msg.id !== 'loading')
                .concat({
                  message:
                    'Error: Failed to fetch response. Please try again.',
                  sender: 'robot',
                  id: crypto.randomUUID(),
                })
            );
          }
          setIsLoading(false);
        }

        return (
          <>
            <div className="chat-msg-container"
              ref = {chatMsgesRef}
            >
              {chatMessages.map((chatMessage) => (
                <ChatMessage
                  key={chatMessage.id}
                  message={chatMessage.message}
                  sender={chatMessage.sender}
                />
              ))}
            </div>
            <ChatInput onSend={sendMessage} isLoading={isLoading} />
          </>
        );
      }

      function App() {
        return (
          <div className="app-container">
            <ChatMessages />
          </div>
        );
      }

      const container = document.querySelector('.js-container');
      ReactDOM.createRoot(container).render(<App />);
    </script>
  </body>
</html>

<!--Hooks = insert React features into our component  -->